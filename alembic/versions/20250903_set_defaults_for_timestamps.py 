# --- START OF FILE: alembic/versions/20250903_set_defaults_for_timestamps.py ---
"""Set DEFAULT now() for created_at/updated_at (no triggers)

Revision ID: 20250903_set_defaults_for_timestamps
Revises: 20250903_add_order_type
Create Date: 2025-09-03 21:00:00.000000
"""
from alembic import op
import sqlalchemy as sa

# revision identifiers, used by Alembic.
revision = "20250903_set_defaults_for_timestamps"
down_revision = "20250903_add_order_type"
branch_labels = None
depends_on = None


def upgrade() -> None:
    # 1) ضع DEFAULT على مستوى قاعدة البيانات
    op.execute("ALTER TABLE recommendations ALTER COLUMN created_at SET DEFAULT now();")
    op.execute("ALTER TABLE recommendations ALTER COLUMN updated_at SET DEFAULT now();")

    # 2) أصلح الصفوف القديمة التي فيها NULL
    op.execute("UPDATE recommendations SET created_at = now() WHERE created_at IS NULL;")
    op.execute("UPDATE recommendations SET updated_at = now() WHERE updated_at IS NULL;")


def downgrade() -> None:
    # إزالة DEFAULT فقط (لا توجد دوال/تريجر في هذا الترحيل)
    op.execute("ALTER TABLE recommendations ALTER COLUMN updated_at DROP DEFAULT;")
    op.execute("ALTER TABLE recommendations ALTER COLUMN created_at DROP DEFAULT;")
# --- END OF FILE ---