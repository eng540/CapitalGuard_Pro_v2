<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Live Portfolio</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #000000; --card: #1c1c1e; --text: #fff; --hint: #8e8e93;
            --green: #32d74b; --red: #ff453a; --blue: #0a84ff; --border: #2c2c2e;
        }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 16px; }
        
        /* Skeleton Loading Animation */
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        .loading { animation: pulse 1.5s infinite; color: var(--blue); text-align: center; margin-top: 50px; }

        /* UI Elements */
        .stats-header { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: var(--card); padding: 10px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .stat-val { font-size: 1.1rem; font-weight: bold; margin-top: 5px; }
        .stat-label { font-size: 0.7rem; color: var(--hint); }
        
        .pos-card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid var(--border); }
        .pos-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .pos-symbol { font-weight: bold; font-size: 1.1rem; }
        .pos-pnl { font-weight: bold; }
        .green { color: var(--green); } .red { color: var(--red); }

        .error-box { background: rgba(255, 0, 0, 0.1); border: 1px solid var(--red); color: var(--red); padding: 15px; border-radius: 10px; text-align: center; display: none; }
        .retry-btn { background: var(--blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <!-- Error Container -->
    <div id="errorBox" class="error-box">
        <div id="errorText">Unknown Error</div>
        <button class="retry-btn" onclick="location.reload()">ðŸ”„ Reload</button>
    </div>

    <!-- Main UI (Hidden until loaded) -->
    <div id="mainUI" style="display:none;">
        <div class="stats-header">
            <div class="stat-card">
                <div class="stat-label">Unrealized PnL</div>
                <div class="stat-val" id="uPnl">0.00%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total PnL</div>
                <div class="stat-val" id="tPnl">0.00%</div>
            </div>
        </div>
        <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--hint);">ACTIVE POSITIONS</h4>
        <div id="positionsList"></div>
    </div>

    <!-- Loader -->
    <div id="loader" class="loading">
        <h3>ðŸ”„ Connecting...</h3>
        <p style="font-size: 0.8rem; color: #666;">Waiting for Telegram Data</p>
    </div>

    <script>
        // Global Error Handler to catch crashes
        window.onerror = function(msg, url, line) {
            showError(`System Error: ${msg} (Line ${line})`);
            return true;
        };

        const tg = window.Telegram.WebApp;
        tg.expand();

        function showError(msg) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('mainUI').style.display = 'none';
            document.getElementById('errorBox').style.display = 'block';
            document.getElementById('errorText').innerText = msg;
        }

        async function init() {
            try {
                // 1. Check Telegram Data
                if (!tg.initData) {
                    // If opened in browser, show specific error
                    throw new Error("No Telegram Data. Please open from inside Telegram Bot.");
                }

                // 2. Fetch Data
                const res = await fetch(`/api/webapp/portfolio?initData=${encodeURIComponent(tg.initData)}`);
                
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }

                const data = await res.json();

                if (!data.ok) {
                    throw new Error(data.error || "Backend Error");
                }

                // 3. Render
                render(data);

            } catch (e) {
                showError(e.message);
            }
        }

        function render(data) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('mainUI').style.display = 'block';

            // Stats
            const stats = data.stats;
            const uPnl = document.getElementById('uPnl');
            uPnl.innerText = stats.unrealized_pnl;
            uPnl.className = `stat-val ${parseFloat(stats.unrealized_pnl) >= 0 ? 'green' : 'red'}`;
            document.getElementById('tPnl').innerText = stats.total_pnl;

            // List
            const list = document.getElementById('positionsList');
            list.innerHTML = '';
            
            if (data.active.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">No active positions</div>';
                return;
            }

            data.active.forEach(pos => {
                const pnlClass = pos.pnl >= 0 ? 'green' : 'red';
                const card = document.createElement('div');
                card.className = 'pos-card';
                card.innerHTML = `
                    <div class="pos-header">
                        <div class="pos-symbol">${pos.asset} <span style="font-size:0.8rem; color:#666;">${pos.side}</span></div>
                        <div class="pos-pnl ${pnlClass}">${pos.pnl}%</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                        <span style="color:var(--hint)">Entry: ${pos.entry}</span>
                        <span style="color:var(--hint)">Mark: ${pos.live_price}</span>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // Start
        setTimeout(init, 500); // Small delay to ensure TG is ready
    </script>
</body>
</html>