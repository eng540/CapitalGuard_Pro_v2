<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CapitalGuard Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-body: #090b0e; --bg-card: #161a1e; --bg-sheet: #1e2329;
            --accent-buy: #0ecb81; --accent-sell: #f6465d; --accent-primary: #f0b90b;
            --text-main: #eaecef; --text-sub: #848e9c; --border: #2b3139;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 100px; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Header */
        .header { padding: 20px; background: rgba(22,26,30,0.95); position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--border); backdrop-filter: blur(10px); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .stat-card { background: var(--bg-card); padding: 12px; border-radius: 12px; border: 1px solid var(--border); }
        .stat-label { font-size: 11px; color: var(--text-sub); text-transform: uppercase; }
        .stat-value { font-size: 16px; font-weight: 700; }
        .green { color: var(--accent-buy); } .red { color: var(--accent-sell); }

        /* Tabs */
        .tabs { display: flex; gap: 20px; margin-top: 20px; border-bottom: 1px solid var(--border); padding: 0 20px; }
        .tab { padding-bottom: 12px; font-size: 14px; font-weight: 600; color: var(--text-sub); cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { color: var(--text-main); border-bottom-color: var(--accent-primary); }

        /* Card */
        .card { background: var(--bg-card); border-radius: 16px; padding: 18px; margin: 16px; margin-bottom: 12px; position: relative; border: 1px solid transparent; cursor: pointer; }
        .card:active { transform: scale(0.98); background: #1f242a; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .pair { font-size: 16px; font-weight: 700; }
        .side-tag { font-size: 10px; font-weight: 800; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; }
        .long-tag { color: var(--accent-buy); background: rgba(14, 203, 129, 0.15); }
        .short-tag { color: var(--accent-sell); background: rgba(246, 70, 93, 0.15); }
        .pnl-badge { font-size: 14px; font-weight: 700; padding: 6px 12px; border-radius: 8px; }
        .pnl-pos { background: rgba(14, 203, 129, 0.15); color: var(--accent-buy); }
        .pnl-neg { background: rgba(246, 70, 93, 0.15); color: var(--accent-sell); }

        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .lbl { font-size: 12px; color: var(--text-sub); margin-bottom: 4px; }
        .val { font-size: 14px; font-weight: 600; }

        /* Risk Visualization */
        .price-visualization { margin-top: 15px; }
        .risk-bar-container { margin-top: 8px; height: 6px; background: #2b3139; border-radius: 3px; position: relative; }
        .risk-fill { height: 100%; position: absolute; top: 0; border-radius: 3px; opacity: 0.3; }
        .price-marker { position: absolute; top: -2px; width: 3px; height: 10px; border-radius: 2px; z-index: 2; }
        .marker-sl { background: var(--accent-sell); left: 0%; }
        .marker-entry { background: var(--text-sub); left: 30%; }
        .marker-current { background: #fff; width: 4px; height: 12px; top: -3px; border-radius: 2px; z-index: 3; transition: left 0.5s; }
        .marker-tp { background: var(--accent-buy); right: 0%; }

        /* Targets */
        .targets-preview { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
        .target-pill { background: var(--bg-sheet); padding: 4px 8px; border-radius: 6px; font-size: 10px; border: 1px solid var(--border); }
        .target-hit { color: var(--accent-buy); border-color: var(--accent-buy); }

        /* Bottom Sheet */
        .sheet-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(4px); }
        .sheet-overlay.open { opacity: 1; visibility: visible; }
        .bottom-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: var(--bg-sheet); border-radius: 24px 24px 0 0; padding: 24px; z-index: 101; transition: bottom 0.3s; box-shadow: 0 -10px 40px rgba(0,0,0,0.5); }
        .sheet-overlay.open .bottom-sheet { bottom: 0; }
        
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .action-btn { background: #2b3139; border: none; padding: 16px; border-radius: 12px; color: var(--text-main); font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .btn-danger { background: rgba(246, 70, 93, 0.15); color: var(--accent-sell); }

        /* Loader */
        .loader { text-align: center; padding: 40px; color: var(--text-sub); }
        .error-msg { color: var(--accent-sell); text-align: center; padding: 20px; background: rgba(246,70,93,0.1); margin: 20px; border-radius: 10px;}

        /* FAB */
        .fab { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background: var(--accent-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; color: #000; cursor: pointer; box-shadow: 0 4px 20px rgba(240, 185, 11, 0.4); z-index: 90; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <div style="font-size: 12px; color: var(--text-sub);">TOTAL PNL (LIVE)</div>
            <div class="stat-value green mono" id="totalPnL">--</div>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Active Trades</div>
                <div class="stat-value" id="activeCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Watchlist</div>
                <div class="stat-value" id="watchCount">0</div>
            </div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="filter('ACTIVE', this)">Active</div>
        <div class="tab" onclick="filter('WATCHLIST', this)">Watchlist</div>
        <div class="tab" onclick="filter('CLOSED', this)">History</div>
    </div>

    <div id="loader" class="loader">Connecting Securely...</div>
    <div id="errorBox" class="error-msg" style="display:none"></div>
    <div id="tradeList"></div>

    <div class="fab" onclick="openTradeCreator()">+</div>

    <div class="sheet-overlay" id="sheetOverlay" onclick="closeSheet()">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2 style="margin:0; font-size:20px;" id="sheetTitle">---</h2>
                <span style="font-size:24px; cursor:pointer;" onclick="closeSheet()">√ó</span>
            </div>
            
            <div style="background:var(--bg-card); padding:15px; border-radius:12px;">
                <div style="display:flex; justify-content:space-between;">
                    <span class="lbl">Entry</span> <span class="val mono" id="sheetEntry">--</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:8px;">
                    <span class="lbl">Current</span> <span class="val mono" id="sheetCurrent">--</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:8px;">
                    <span class="lbl">SL</span> <span class="val mono" id="sheetSL">--</span>
                </div>
            </div>

            <div class="action-grid">
                <button class="action-btn" onclick="sendAction('edit')">‚úèÔ∏è Edit</button>
                <button class="action-btn" onclick="sendAction('breakeven')">üõ°Ô∏è Breakeven</button>
                <button class="action-btn" onclick="sendAction('partial')">üí∞ Take 50%</button>
                <button class="action-btn btn-danger" onclick="sendAction('close')">‚ùå Close</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let allTrades = [];
        let currentFilter = 'ACTIVE';
        let selectedTradeId = null;

        // --- Auth ---
        function waitForInitData(maxRetries = 20) {
            return new Promise((resolve) => {
                let attempts = 0;
                const check = () => {
                    if (tg.initData) return resolve(tg.initData);
                    attempts++;
                    if (attempts >= maxRetries) return resolve(null);
                    setTimeout(check, 250);
                };
                check();
            });
        }

        // --- Fetch ---
        async function fetchData() {
            const initData = await waitForInitData();
            if (!initData) {
                showError("Auth Failed. Open from Telegram.");
                return;
            }

            try {
                const res = await fetch(`/api/webapp/portfolio?initData=${encodeURIComponent(initData)}`);
                if (!res.ok) throw new Error("Server Error");
                const data = await res.json();
                if (data.ok) {
                    allTrades = data.portfolio.items || [];
                    renderUI();
                    document.getElementById('loader').style.display = 'none';
                } else {
                    showError(data.error);
                }
            } catch (e) {
                showError("Connection Error");
            }
        }

        // --- Render ---
        function renderUI() {
            // Summary
            const active = allTrades.filter(t => t.unified_status === 'ACTIVE');
            const watch = allTrades.filter(t => t.unified_status === 'WATCHLIST');
            let totalPnL = 0;
            active.forEach(t => totalPnL += parseFloat(t.pnl_live || 0));
            
            document.getElementById('totalPnL').innerText = (totalPnL>0?'+':'')+totalPnL.toFixed(2)+'%';
            document.getElementById('totalPnL').className = `stat-value mono ${totalPnL>=0?'green':'red'}`;
            document.getElementById('activeCount').innerText = active.length;
            document.getElementById('watchCount').innerText = watch.length;

            // List
            const container = document.getElementById('tradeList');
            container.innerHTML = '';
            
            const filtered = allTrades.filter(t => {
                if (currentFilter === 'ACTIVE') return t.unified_status === 'ACTIVE';
                if (currentFilter === 'WATCHLIST') return ['WATCHLIST', 'PENDING_ACTIVATION'].includes(t.unified_status);
                return t.unified_status === 'CLOSED';
            });

            if (filtered.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-sub);">No ${currentFilter.toLowerCase()} trades.</div>`;
                return;
            }

            filtered.forEach(t => {
                const isLong = t.side === 'LONG';
                const pnl = parseFloat(t.pnl_live || 0);
                const isProf = pnl >= 0;
                
                // Risk Meter Logic
                let progress = 30; // Entry
                if (t.live_price && t.entry) {
                    const entry = parseFloat(t.entry);
                    const curr = parseFloat(t.live_price);
                    const diff = ((curr - entry) / entry) * 100;
                    const shift = (isLong ? diff : -diff) * 5; // Scale
                    progress = Math.max(0, Math.min(100, 30 + shift));
                }

                // Targets HTML
                const targetsHtml = (t.targets || []).map((tg, i) => `
                    <div class="target-pill ${tg.hit ? 'target-hit' : ''}">
                        ${tg.hit?'‚úÖ':'‚è≥'} ${parseFloat(tg.price).toFixed(2)}
                    </div>
                `).join('');

                const html = `
                <div class="card" onclick="openSheet(${t.id})">
                    <div class="card-header">
                        <div class="pair">${t.asset} <span style="font-size:12px; color:var(--text-sub);">${t.leverage}</span></div>
                        <div class="pnl-badge ${isProf?'pnl-pos':'pnl-neg'}">${(pnl>0?'+':'')}${pnl.toFixed(2)}%</div>
                    </div>
                    
                    <div class="card-grid">
                        <div class="data-point">
                            <span class="lbl">Entry</span>
                            <span class="val mono">${parseFloat(t.entry).toFixed(4)}</span>
                        </div>
                        <div class="data-point">
                            <span class="lbl">Mark</span>
                            <span class="val mono" style="color:${isProf?'var(--accent-buy)':'var(--accent-sell)'}">${parseFloat(t.live_price||0).toFixed(4)}</span>
                        </div>
                    </div>

                    ${currentFilter === 'ACTIVE' ? `
                    <div class="price-visualization">
                        <div class="risk-bar-container">
                            <div class="risk-fill" style="width:${isLong?'100%':'100%'}; background:${isLong?'var(--accent-buy)':'var(--accent-sell)'}; left:0;"></div>
                            <div class="price-marker marker-sl"></div>
                            <div class="price-marker marker-entry"></div>
                            <div class="price-marker marker-tp"></div>
                            <div class="marker-current" style="left:${progress}%"></div>
                        </div>
                    </div>` : ''}
                    
                    <div class="targets-preview">${targetsHtml}</div>
                </div>`;
                container.innerHTML += html;
            });
        }

        function openSheet(id) {
            selectedTradeId = id;
            const t = allTrades.find(x => x.id === id);
            if(!t) return;

            document.getElementById('sheetTitle').innerText = t.asset;
            document.getElementById('sheetEntry').innerText = t.entry;
            document.getElementById('sheetCurrent').innerText = t.live_price;
            document.getElementById('sheetSL').innerText = t.stop_loss;
            document.getElementById('sheetOverlay').classList.add('open');
            tg.HapticFeedback.impactOccurred('light');
        }

        function closeSheet() {
            document.getElementById('sheetOverlay').classList.remove('open');
        }

        function sendAction(action) {
            // Close WebApp and send signal to bot to trigger action menu
            // This is the most reliable way without dedicated write endpoints
            tg.close();
            // We could also use tg.sendData(JSON.stringify({action, id: selectedTradeId}));
            // if we had a MessageHandler for WebAppData. 
            // For now, closing lets the user use the bot interface which we know works.
        }
        
        function openTradeCreator() { tg.close(); } // Simplified for now

        function filter(status, tab) {
            currentFilter = status;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            renderUI();
        }

        function showError(msg) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('errorBox').innerText = msg;
            document.getElementById('errorBox').style.display = 'block';
        }

        setInterval(fetchData, 8000);
        fetchData();
    </script>
</body>
</html>
