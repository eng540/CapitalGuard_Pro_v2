<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CapitalGuard Portfolio</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');
        
        :root {
            --bg-app: #0b0e11; --bg-card: #1e2329; --bg-card-hover: #2a2e35;
            --text-primary: #eaecef; --text-secondary: #848e9c;
            --brand-green: #0ecb81; --brand-red: #f6465d; --brand-yellow: #f0b90b;
            --border: rgba(255,255,255,0.05);
        }

        body { background-color: var(--bg-app); color: var(--text-primary); font-family: 'Inter', sans-serif; margin: 0; padding: 0; padding-bottom: 100px; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Header */
        .dashboard-header { padding: 20px 16px; background: linear-gradient(180deg, rgba(30,35,41,0.95) 0%, rgba(11,14,17,0) 100%); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); }
        .app-title { font-size: 18px; font-weight: 700; color: var(--brand-yellow); }
        
        /* Summary */
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .summary-card { background: var(--bg-card); border-radius: 12px; padding: 12px; border: 1px solid var(--border); }
        .summary-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; display: block; }
        .summary-value { font-size: 20px; font-weight: 700; font-family: 'JetBrains Mono', monospace; margin-top: 4px; }
        .pos { color: var(--brand-green); } .neg { color: var(--brand-red); }

        /* List */
        .container { padding: 16px; }
        .trade-card { background: var(--bg-card); border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--border); }
        .card-top { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .pair-name { font-weight: 700; font-size: 16px; }
        .side-badge { font-size: 11px; font-weight: 800; padding: 4px 8px; border-radius: 4px; }
        .bg-long { color: var(--brand-green); background: rgba(14, 203, 129, 0.15); }
        .bg-short { color: var(--brand-red); background: rgba(246, 70, 93, 0.15); }
        
        .price-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-lbl { font-size: 11px; color: var(--text-secondary); }
        .stat-val { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; }

        /* Loader & Errors */
        .loader { text-align: center; padding: 50px; color: var(--text-secondary); }
        .error-container { text-align: center; padding: 20px; background: rgba(246, 70, 93, 0.1); border-radius: 12px; margin: 20px; }
        .retry-btn { background: var(--brand-yellow); color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        
        .debug-info { font-size: 10px; color: #555; margin-top: 20px; word-break: break-all; display: none; }
    </style>
</head>
<body>

    <div class="dashboard-header">
        <div class="app-title">CapitalGuard Portfolio</div>
        <div class="summary-grid">
            <div class="summary-card">
                <span class="summary-label">Active PnL</span>
                <div class="summary-value" id="totalPnL">--</div>
            </div>
            <div class="summary-card">
                <span class="summary-label">Positions</span>
                <div class="summary-value" id="activeCount">0</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="loader" class="loader">Initializing Secure Connection...</div>
        <div id="errorState" style="display:none;" class="error-container"></div>
        <div id="tradeList"></div>
    </div>

    <div id="debugInfo" class="debug-info"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Force HTTPS
        if (window.location.protocol === 'http:') {
             window.location.href = window.location.href.replace('http:', 'https:');
        }

        function showDebug(msg) {
            const el = document.getElementById('debugInfo');
            el.style.display = 'block';
            el.innerHTML += `<div>${msg}</div>`;
        }

        function showError(msg, allowRetry = true) {
            document.getElementById('loader').style.display = 'none';
            const errEl = document.getElementById('errorState');
            errEl.style.display = 'block';
            errEl.innerHTML = `
                <div style="font-weight:bold; margin-bottom:8px;">‚ö†Ô∏è ${msg}</div>
                ${allowRetry ? '<button class="retry-btn" onclick="location.reload()">üîÑ Force Reload</button>' : ''}
            `;
        }

        // --- Robust Data Extraction ---
        function getTelegramData() {
            // 1. Try standard initData
            if (tg.initData) return tg.initData;
            
            // 2. Try initDataUnsafe (sometimes populated while initData is empty string on Android)
            // We can manually reconstruct the query string from unsafe data if needed, 
            // but usually if initData is empty, it means the bridge failed.
            
            // 3. Try URL Hash
            const hash = window.location.hash.slice(1);
            const params = new URLSearchParams(hash);
            if (params.has('tgWebAppData')) return params.get('tgWebAppData');
            
            return null;
        }

        function waitForInitData(maxRetries = 20) {
            return new Promise((resolve) => {
                let attempts = 0;
                const check = () => {
                    const data = getTelegramData();
                    if (data) return resolve(data);
                    attempts++;
                    if (attempts >= maxRetries) return resolve(null);
                    setTimeout(check, 250); // Wait up to 5 seconds
                };
                check();
            });
        }

        async function fetchPortfolio() {
            const initData = await waitForInitData();

            if (!initData) {
                showError("Authentication Failed.<br>Could not detect Telegram session.", true);
                showDebug(`Platform: ${tg.platform}, Version: ${tg.version}`);
                return;
            }

            try {
                const res = await fetch(`/api/webapp/portfolio?initData=${encodeURIComponent(initData)}`);
                
                if (!res.ok) {
                    if (res.status === 403) showError("üîí Session Expired. Please reload.");
                    else showError(`Server Error (${res.status})`);
                    return;
                }

                const data = await res.json();
                if (data.ok) {
                    renderTrades(data.portfolio.items || []);
                } else {
                    showError("API Error: " + data.error);
                }
            } catch (e) {
                showError("Network Error");
                showDebug(e.message);
            }
        }

        function renderTrades(trades) {
            document.getElementById('loader').style.display = 'none';
            const container = document.getElementById('tradeList');
            container.innerHTML = '';
            
            let totalPnL = 0;
            let activeCount = 0;

            if (trades.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#666; margin-top:30px;">No open trades found.</div>';
                return;
            }

            trades.forEach(t => {
                if (t.unified_status === 'ACTIVE') {
                    activeCount++;
                    totalPnL += parseFloat(t.pnl_live || 0);
                }
                
                const isLong = t.side === 'LONG';
                const pnl = parseFloat(t.pnl_live || 0);
                const isProfitable = pnl >= 0;
                const badgeClass = isLong ? 'bg-long' : 'bg-short';
                const pnlColor = isProfitable ? 'var(--brand-green)' : 'var(--brand-red)';

                const html = `
                <div class="trade-card" onclick="tg.openLink('https://t.me/${tg.initDataUnsafe?.start_param || 'Tradingplatformxbot'}/signal_dashboard.html?id=${t.id}')">
                    <div class="card-top">
                        <div class="pair-name">${t.asset}</div>
                        <div class="side-badge ${badgeClass}">${t.side}</div>
                    </div>
                    <div class="price-stats">
                        <div>
                            <div class="stat-lbl">Entry</div>
                            <div class="stat-val">${parseFloat(t.entry).toFixed(4)}</div>
                        </div>
                        <div style="text-align:right;">
                            <div class="stat-lbl">PnL</div>
                            <div class="stat-val" style="color:${pnlColor}">${(pnl>0?'+':'')}${pnl.toFixed(2)}%</div>
                        </div>
                    </div>
                </div>
                `;
                container.innerHTML += html;
            });

            document.getElementById('totalPnL').innerText = (totalPnL>0?'+':'') + totalPnL.toFixed(2) + "%";
            document.getElementById('totalPnL').className = `summary-value ${totalPnL>=0?'pos':'neg'}`;
            document.getElementById('activeCount').innerText = activeCount;
        }

        fetchPortfolio();
    </script>
</body>
</html>
